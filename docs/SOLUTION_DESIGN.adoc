= Solution Design Document
:toc: auto
:toclevels: 3

== Overview

Robotechy is Isaac Weeks' 3D printing Bitcoin store built on the Nostr protocol, enabling Bitcoin-native commerce through the Lightning Network. The store displays products exclusively from the Robotechy merchant account - it is a single-vendor storefront, not a multi-vendor marketplace.

== Architecture

=== Technology Stack

* **Frontend**: React 18, TypeScript, Vite
* **Styling**: TailwindCSS 3, shadcn/ui components
* **Protocol**: Nostr (NIP-99, Gamma Markets spec)
* **Payments**: Lightning Network (NWC, WebLN)
* **State Management**: TanStack Query, React Context

=== Component Architecture

[source]
----
App.tsx
├── UnheadProvider (SEO)
│   └── AppProvider (theme, relay config)
│       └── QueryClientProvider (data caching)
│           └── NostrLoginProvider (auth)
│               └── NostrProvider (relay connections)
│                   └── NWCProvider (wallet)
│                       └── CartProvider (shopping cart)
│                           └── AppRouter (routes)
----

== Nostr Protocol Implementation

=== Product Catalog (NIP-99)

Products use Kind 30402 (addressable events) with Gamma Markets spec extensions:

[cols="1,2", options="header"]
|===
|Tag |Purpose

|`d` |Unique product identifier
|`title` |Product name
|`price` |Amount, currency, frequency
|`image` |Product images with dimensions
|`visibility` |hidden, on-sale, pre-order
|`stock` |Available quantity
|`spec` |Product specifications
|`t` |Category tags
|===

=== Shopping Cart

The shopping cart is client-side only (no Nostr events) with localStorage persistence:

* **CartContext**: Provides cart state and operations to all components
* **CartItem**: Product ID, quantity, full product data for display
* **Operations**: addItem, removeItem, updateQuantity, clearCart

=== Checkout Flow (Gamma Markets)

The checkout uses Kind 16 for order processing:

1. **Order Creation (Type 1)**: Buyer sends order details to merchant
2. **Payment Request (Type 2)**: Merchant responds with Lightning invoice
3. **Status Update (Type 3)**: Order status changes
4. **Shipping Update (Type 4)**: Tracking information

Kind 17 is used for payment receipts with proof (preimage).

==== Kind 16 Order Tags (Type 1)

[cols="1,2", options="header"]
|===
|Tag |Purpose

|`type` |Message type (1, 2, 3, or 4)
|`order` |UUID generated by buyer
|`amount` |Total in satoshis
|`item` |Product ID + quantity (repeatable)
|`p` |Merchant pubkey (hex)
|`subject` |Order subject line
|`address` |Shipping address
|`email` |Contact email
|`phone` |Contact phone (optional)
|===

==== Kind 17 Payment Receipt Tags

[cols="1,2", options="header"]
|===
|Tag |Purpose

|`order` |Order UUID reference
|`p` |Merchant pubkey
|`payment` |Payment method, invoice, preimage
|`amount` |Amount paid in satoshis
|===

== Payment Integration

=== Nostr Wallet Connect (NWC)

* Primary payment method for authenticated users
* Supports automatic invoice payment
* 15-second timeout with fallback to manual payment

=== WebLN

* Browser-based wallet integration
* Fallback when NWC is not configured
* Requires compatible browser extension

=== Manual Payment

* QR code display for Lightning invoices
* Copy-to-clipboard functionality
* Open-in-wallet deep linking

== Security Considerations

* Order notifications use NIP-04 encrypted DMs (compatible with Damus/Primal)
* Kind 16/17 order events are public but contain no sensitive data
* Private keys never leave the user's signer
* No centralized user accounts - Nostr identity only
* Product data integrity verified via event signatures
* Merchant nsec stored securely in environment variables (never committed)

== Data Flow

=== Product Discovery

[source]
----
User Request → NostrProvider → Relay Query (Kind 30402) → Parse/Validate → Display
----

=== Order Submission

[source]
----
Cart → Shipping Form → Create Kind 16 Event → Sign → Publish → Send NIP-04 DM → Subscribe for Payment Request
----

=== Payment Processing

[source]
----
Receive Invoice → NWC/WebLN Pay → Get Preimage → Create Kind 17 Receipt → Publish
----

== Order Processing Service

A Node.js backend service (`order-service/`) handles merchant-side automation:

=== Architecture

[source]
----
order-service/
├── index.js              # Main entry point
├── package.json          # Dependencies
├── .env.example          # Environment template
└── lib/
    ├── config.js         # Load environment variables
    ├── nostr.js          # Subscribe & publish (Kind 16 + NIP-04 DMs)
    ├── lightning.js      # LNURL-pay resolution
    └── orderParser.js    # Parse Kind 16/17 events
----

=== Order Flow Diagram

[source]
----
BUYER (Frontend)                    MERCHANT (Backend Service)
      |                                      |
      |  1. Kind 16 Type 1 (Order)           |
      |  --------------------------------->  |
      |                                      |
      |  2. NIP-04 DM (Order Summary)        |
      |  --------------------------------->  | (Merchant sees in Damus)
      |                                      |
      |                                      |  3. Resolve Lightning Address
      |                                      |  4. Generate BOLT11 Invoice
      |                                      |
      |  5. Kind 16 Type 2 (Payment Request) |
      |  <---------------------------------  |
      |                                      |
      |  6. NIP-04 DM (Invoice Link)         |
      |  <---------------------------------  | (Buyer sees if page closed)
      |                                      |
      |  7. Display invoice QR (if on page)  |
      |                                      |
      |  8. Kind 17 (Payment Receipt)        |
      |  --------------------------------->  | (Buyer confirms payment)
      |                                      |
      |  9. NIP-04 DM (Thank You)            |
      |  <---------------------------------  | (Buyer sees confirmation)
      |                                      |
----

=== NIP-04 DM Notifications

Kind 16/17 events are Gamma Markets protocol events that are not visible in standard Nostr clients like Damus or Primal. To ensure both merchant and buyer can see order updates in their regular DM clients:

|===
|Direction |Content |Purpose

|Buyer → Merchant |Order summary with items, shipping, total |Isaac sees new orders in Damus
|Merchant → Buyer |Invoice link (lightning:...) |Buyer can pay even if page is closed
|Merchant → Buyer |Thank you confirmation |Buyer sees payment was received
|===

=== Lightning Invoice Generation

The service uses LNURL-pay to generate invoices:

1. Parse Lightning Address (e.g., `robotechy@getalby.com`)
2. Resolve to LNURL endpoint: `https://getalby.com/.well-known/lnurlp/robotechy`
3. Request invoice: `{callback}?amount={msats}&comment={orderId}`
4. Publish BOLT11 invoice in Kind 16 Type 2 response

=== Relay Strategy

To ensure reliable message delivery:

* Backend fetches merchant's NIP-65 relay list (Kind 10002) at startup
* When publishing, fetches recipient's NIP-65 relays and publishes to both sets
* Falls back to configured relays if NIP-65 lookup fails
