= Troubleshooting Guide
:toc: auto
:toclevels: 2

== Common Issues

[cols="1,2", options="header"]
|===
|Problem |Solution

|Dev server fails to start on port 8080
|Port may be in use. Run `lsof -i :8080` to check. Either stop the conflicting service or use `npx vite --port 8081`

|Missing dependencies for react-markdown
|Run `npm install` to reinstall all dependencies. If persists, delete `node_modules` and reinstall

|`style-to-js` does not provide export named 'default'
|Clear Vite cache with `rm -rf node_modules/.vite`, restart dev server, and hard refresh browser (Ctrl+Shift+R). The `vite.config.ts` includes `optimizeDeps.include: ['style-to-js']` to handle this

|"Could not resolve" errors for devlop, hast-util-to-jsx-runtime, etc
|These are react-markdown 10.x peer dependencies. They should be in package.json. Run `npm install` and restart the dev server

|TypeScript errors on build
|Run `npm run test` to see full error output. Check for missing type imports or incorrect type usage

|Products not loading from Nostr relays
|Check relay connectivity. Verify MERCHANT_PUBKEY in `src/hooks/useProducts.ts` is correct

|Wallet connection fails (NWC)
|Ensure the NWC connection string is valid. Check that the wallet service is online

|Images not displaying on products
|Verify image URLs are accessible. Check for CORS issues. Images must be publicly accessible

|Cart not persisting between sessions
|Check localStorage is enabled in browser. Clear localStorage and retry

|Checkout order not submitting
|Ensure you are logged in with a Nostr extension. Check browser console for signing errors

|Payment request not appearing after order
|The merchant must be online to respond. Check relay connectivity. Verify MERCHANT_PUBKEY is correct

|NWC payment fails with timeout
|Check NWC connection string is valid. Wallet service must be online and have sufficient balance

|Login not working with Nostr extension
|Ensure a NIP-07 compatible extension (Alby, nos2x) is installed and unlocked

|ESLint errors blocking build
|Run `npx eslint --fix .` to auto-fix. Check for "// In a real" placeholder comments

|Hot reload not working
|Restart the dev server. Check for syntax errors preventing compilation
|===

== Exchange Rates

=== Multi-Exchange Averaging

The frontend converts between fiat (GBP/USD/EUR) and sats using live exchange rates averaged from three sources:

* **CoinGecko** - `api.coingecko.com`
* **Kraken** - `api.kraken.com`
* **Coinbase** - `api.coinbase.com`

[source]
----
src/lib/exchangeRate.ts    # Core rate fetching and conversion
src/hooks/useExchangeRate.ts  # React hook for components
----

=== Rate Caching

Rates are cached for 5 minutes to avoid API rate limiting. If all exchanges fail, stale cached rates are used as fallback.

=== Fallback Rates

If no exchanges respond, hardcoded fallback rates are used:

* BTC/GBP: £80,000
* BTC/USD: $100,000

These are approximate and should only activate if all three APIs are down simultaneously.

=== Exchange Rate Issues

[cols="1,2", options="header"]
|===
|Problem |Solution

|Exchange rate shows 0 or NaN
|Check browser console for API errors. May be a CORS issue or API outage

|Sats amount seems wrong
|Verify the exchange rate in browser console: `await getExchangeRates()`. Compare with current market rate

|API rate limiting (429 errors)
|The 5-minute cache should prevent this. If occurring, check for multiple tabs or rapid page refreshes
|===

== Order Service

=== Starting the Service

[source,bash]
----
# From project root
npm run dev:orders

# Or directly
cd order-service && node index.js
----

=== Relay Error Handling

The order service connects to multiple Nostr relays. Many relay errors are expected and safely ignored:

[cols="1,2", options="header"]
|===
|Error Pattern |Cause

|`restricted: Pay on https://...`
|Paid relay, requires subscription

|`blocked: kind 16 is not allowed`
|Relay doesn't support Gamma Markets events

|`rate-limited: you are noting too much`
|Too many events published in quick succession

|`Received network error or non-101`
|Relay connection failed or WebSocket handshake error

|`sign up at https://... to write events`
|Relay requires registration
|===

These errors are logged as warnings but don't crash the service. The service continues operating with relays that accept the events.

=== Rate Limiting Mitigation

To avoid rate limiting when publishing multiple events:

* **2-second delay** between publishing Kind 16 payment request and NIP-04 DM
* Events published to all relays in parallel (some may reject)
* Success requires at least one relay to accept

=== Service Crashes

If the order service crashes unexpectedly:

1. Check the logs for `[Fatal]` messages
2. New error patterns may need to be added to the ignore list in `order-service/index.js`:

[source,javascript]
----
// Add new patterns to this list
if (msg.includes('restricted') ||
    msg.includes('rate-limit') ||
    msg.includes('new-error-pattern')) {  // <-- Add here
  console.warn('[Nostr] Ignoring relay rejection:', msg);
  return;
}
----

=== Order Service Issues

[cols="1,2", options="header"]
|===
|Problem |Solution

|Service won't start - "Invalid Lightning Address"
|Verify the address in `.env` resolves. Test: `curl https://domain/.well-known/lnurlp/username`

|Orders not being received
|Check relay connectivity. Verify merchant pubkey matches. Check `since` filter isn't excluding old events

|Invoice generation fails
|Lightning Address service may be down. Check the LNURL endpoint is responding

|DMs not being sent
|Check for rate limiting in logs. Verify recipient's NIP-65 relays are reachable

|Service crashes on specific relay error
|Add the error pattern to the ignore list (see above)

|Duplicate orders being processed
|The service tracks processed order IDs in memory. Restarting clears this - expected behavior

|Invoice shows 0 sats
|Check the `amount` tag in the Kind 16 Type 1 event. Verify frontend is sending correct amount
|===

=== Monitoring

The order service logs key events:

[source]
----
[Order] New order received!      # Kind 16 Type 1 received
[Order] Generating invoice...    # LNURL-pay request
[Order] Publishing payment...    # Kind 16 Type 2 sent
[Order] Waiting 2s before DM...  # Rate limit delay
[Order] ✓ Invoice DM sent        # NIP-04 DM sent
[Payment] Payment received!      # Kind 17 received
[Payment] ✓ Thank you sent       # Confirmation DM sent
----

Warnings (`console.warn`) indicate non-fatal issues. Only `[Fatal]` messages cause the service to exit.
